version: 2.1

orbs:
  codecov: codecov/codecov@3.2.2

jobs:
  build:
    machine:
      image: circleci/classic:latest

    working_directory: ~/repo

    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Set up test database.
          command: |
            docker pull postgres:9.6.24-alpine3.14
            docker run --network $DOCKER_NETWORK --name database -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD -d postgres
      - run:
          name: Install dockerize.
          command: >-
            sudo apt-get update &&
            sudo apt-get install -y wget &&
            wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz &&
            sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz &&
            sudo rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.6.1
      - checkout
      - run:
          name: Build containers
          command: |
            docker build . -t shopping-mate-back
            docker run --network $DOCKER_NETWORK --name shopping-mate-back \
            -e SECRET_KEY=$SECRET_KEY \
            -e DATABASE_URL=$DATABASE_URL \
            -d shopping-mate-back
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run:
          name: Run tests with coverage
          command: |
            docker exec -it shopping-mate-back pytest
            docker exec -it shopping-mate-back coverage html

workflows:
  build_and_test:
    jobs:
      - build:
          post-steps:
            - codecov/upload
            - store_artifacts:
                path: htmlcov
